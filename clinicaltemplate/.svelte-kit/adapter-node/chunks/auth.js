import{eq as e}from"drizzle-orm";import{sha256 as s}from"@oslojs/crypto/sha2";import{encodeBase64url as r,encodeHexLowerCase as t}from"@oslojs/encoding";import{drizzle as o}from"drizzle-orm/mysql2";import n from"mysql2/promise";import{mysqlTable as i,varchar as a,int as u,datetime as l}from"drizzle-orm/mysql-core";import{l as d}from"./svelte.js";const m=i("user",{id:a("id",{length:255}).primaryKey(),age:u("age"),username:a("username",{length:32}).notNull().unique(),passwordHash:a("password_hash",{length:255}).notNull()}),c=i("session",{id:a("id",{length:255}).primaryKey(),userId:a("user_id",{length:255}).notNull().references(()=>m.id),expiresAt:l("expires_at").notNull()}),p=Object.freeze(Object.defineProperty({__proto__:null,session:c,user:m},Symbol.toStringTag,{value:"Module"}));if(!d.DATABASE_URL)throw new Error("DATABASE_URL is not set");const w=o(n.createPool(d.DATABASE_URL),{schema:p,mode:"default"}),f="auth-session";function h(){const e=crypto.getRandomValues(new Uint8Array(18));return r(e)}async function A(e,r){const o={id:t(s((new TextEncoder).encode(e))),userId:r,expiresAt:new Date(Date.now()+2592e6)};return await w.insert(c).values(o),o}async function y(r){const o=t(s((new TextEncoder).encode(r))),[n]=await w.select({user:{id:m.id,username:m.username},session:c}).from(c).innerJoin(m,e(c.userId,m.id)).where(e(c.id,o));if(!n)return{session:null,user:null};const{session:i,user:a}=n;if(Date.now()>=i.expiresAt.getTime())return await w.delete(c).where(e(c.id,i.id)),{session:null,user:null};return Date.now()>=i.expiresAt.getTime()-1296e6&&(i.expiresAt=new Date(Date.now()+2592e6),await w.update(c).set({expiresAt:i.expiresAt}).where(e(c.id,i.id))),{session:i,user:a}}async function g(s){await w.delete(c).where(e(c.id,s))}function x(e,s,r){e.cookies.set(f,s,{expires:r,path:"/"})}function _(e){e.cookies.delete(f,{path:"/"})}export{w as a,f as b,A as c,_ as d,h as g,g as i,x as s,m as u,y as v};
