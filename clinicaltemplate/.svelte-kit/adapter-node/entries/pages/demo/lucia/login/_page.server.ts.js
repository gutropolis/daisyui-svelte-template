import{hash as e,verify as r}from"@node-rs/argon2";import{encodeBase32LowerCase as s}from"@oslojs/encoding";import{redirect as a,fail as t}from"@sveltejs/kit";import{eq as n}from"drizzle-orm";import{a as o,u as i,g as m,c as u,s as c}from"../../../../../chunks/auth.js";const l=async e=>e.locals.user?a(302,"/demo/lucia"):{},p={login:async e=>{const s=await e.request.formData(),l=s.get("username"),p=s.get("password");if(!g(l))return t(400,{message:"Invalid username (min 3, max 31 characters, alphanumeric only)"});if(!d(p))return t(400,{message:"Invalid password (min 6, max 255 characters)"});const f=(await o.select().from(i).where(n(i.username,l))).at(0);if(!f)return t(400,{message:"Incorrect username or password"});if(!(await r(f.passwordHash,p,{memoryCost:19456,timeCost:2,outputLen:32,parallelism:1})))return t(400,{message:"Incorrect username or password"});const w=m(),h=await u(w,f.id);return c(e,w,h.expiresAt),a(302,"/demo/lucia")},register:async r=>{const n=await r.request.formData(),l=n.get("username"),p=n.get("password");if(!g(l))return t(400,{message:"Invalid username"});if(!d(p))return t(400,{message:"Invalid password"});const f=function(){const e=crypto.getRandomValues(new Uint8Array(15));return s(e)}(),w=await e(p,{memoryCost:19456,timeCost:2,outputLen:32,parallelism:1});try{await o.insert(i).values({id:f,username:l,passwordHash:w});const e=m(),s=await u(e,f);c(r,e,s.expiresAt)}catch{return t(500,{message:"An error has occurred"})}return a(302,"/demo/lucia")}};function g(e){return"string"==typeof e&&e.length>=3&&e.length<=31&&/^[a-z0-9_-]+$/.test(e)}function d(e){return"string"==typeof e&&e.length>=6&&e.length<=255}export{p as actions,l as load};
